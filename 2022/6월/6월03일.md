## 😀 2022.06.03.금

<br/>

# 38장 브라우저의 렌더링과정
브라우저는 다음과 같은 렌더링 과정을 거치게된다.  
1. 브라우저는 HTML,CSS,JS,이미지, 폰트 등 렌더링에 필요한 리소스들을 서버에 요청하고 응답을 받는다. 
2. 응답받은 리소스 HTML,CSS를 파싱해 DOM과 CSSOM을 생성하고 이들을 결합해 렌더트리를 생성한다.
3. 브라우저의 자바스크립트 엔진은 서버로부터 응답된 자바스크립트를 파싱해 AST를 생성하고 바이트 코드로 변환해 실행한다. 이때 DOM API를 통해 DOM이나 CSSOM을 변경할 수 있다. 변경된 DOM과 CSSOM은 다시 렌더 트리로 결합된다.
4. 렌더 트리를 기반으로 HTML 요소의 레이아웃을(위치와 크기)를 계산하고 브라우저 화면에 HTML요소를 페인팅한다.

> 파싱: 작성된 코드를 실행하기위해 텍스트 문서의 문자열을 토큰으로 분해하고 토큰에 문법적 의미와 구조를 반영하여 트리구조의 파스트리를 생성하는 일련의 과정이다.  

## 38.1 요청과 응답

가장먼저 브라우저가 렌더링되기 위해서는 필요한 리소스를 서버로 부터 받아와야한다.  
리소스를 받아오기 위한 과정으로 인터넷 주소창에 원하는 서비스의 URL을 입력하고 엔터를 누르면 DNS를 통해 IP주소로 변환되고 해당IP주소를 갖는 서버에게 리소스를 요청하게 된다.  

### HTTP
요청시 앞에 붙이는 http와 https 이는 웹에서 브라우저와 서버가 통신하기위한 프로토콜이다.  
과거(1999) HTTP1.1은 기본적으로 커넥션 하나당 하나의 요청과 응답만 처리해주었다.  
즉 여러 요청과 응답을 처리하기 위해서는 개발적으로 요청하고 응답을 기다려야만했다. 
그리고 응답을 보내면 받을 때 까지 기다렸다가 다시 요청하는 방식이여서 시간도 오래걸렸다.  
2015년 이런 불편한 부분을 개선해 HTTP/2에서는 한번에 여러 요청과 응답을 받을 수 있게 되었고, 1.1에 비해서 페이지 로드 속도가 50%정도 빨라졌다.  

## 38.3 HTML 파싱과 DOM 생성 
요청에 의해 서버가 응답한 HTTP문서를 렌더링 하기 위해서는 문서를 브라우저가 이해할 수 있는 자료구조(객체)의 형태로 변환 후 메모리에 저장해야한다.   
이런 과정을 파싱이라 하고 HTTP문서를 파싱한 결과 인 자료구조는 DOM이라 부른다.  
다음 HTTP 파싱 과정을 보자.

1. 서버로로 요청한 HTML파일은 인터넷을 경유하여 바이트(2진수)형태로 응답을 받는다.  
2. 응답받은 HTML은 `<meta>`태그의 charset 어트리뷰트에 의해 지정된 인코딩 방식(UTF-8)을 기준으로 문자열로 반환된다.  
3. 문자열로 반환된 HTML문서는 문법적 의미를 갖는 코드의 최소 단위 **토큰** 들로 분해된다.  
4. 각 토큰들은 객체로 변환되어 노드를 생성한다. 이때 내용에따라 문서노드, 요소노드, 어트리뷰트 노드, 텍스트 노드가 생성된다.
5. HTML요소는 요소간의 부자관계를 반영하여 모든 노드를 트리구조로 구성한다. 이렇게 구성된 트리형태의 자료구조를 DOM이라 부른다.


## 38.4 CSS 파싱과 CSSOM 생성
DOM을 생성하다가 CSS를 로드하는 `<link src="..." />`나 스타일 태그를 만나면 DOM 생성을 일시 중단하고 CSS를 파싱한다.  
그렇게 CSSOM이 생성되면 이어서 DOM생성을 재개한다.  
이때 파싱과정은 DOM과 동일한 과정을 거치게된다. (바이트 > 문자 > 토큰 > 노트 > CSSOM)

## 38.5 렌더 트리 생성
이렇게 DOM과 CSSOM이 완성이 되면 이를 랜더링하기 위해 이 둘을 합친 랜더트리가 생성된다.  
랜더트리는 렌더링을 위한 트리구조의 자료구조이다.  
따라서 화면 렌더링에 사용되지 않는 노드 `<meta>`,`<script>`,`display:none`은 노드에 포함되지 않는다.  
이후 완성된 트리는 요소의 레이아웃을 계산되는데 사용되며 브라우저 화면에 픽셀을 렌더링하는 페인팅 처리에 입력된다.  
이후 DOM의 조작에 의해 이런 과정은 반복해서 실행된다.  
레이아웃의 계산과 페인팅은 실행하는 리렌더링은 비용이 많이 든다. 그러므로 이런 리렌더링이 자주 발생되지 않도록 주의해야한다.  

### 리페인팅이 실행하는경우
- JS에 의한 노드 추가/삭제
- 브라우저 리사이징에 의한 viewpote크기변경
- HTML 요소의 레이아웃에 변경을 발생시키는 스타일 변경
  (width/height, margin, padding, border, display, position, top/right/bottom,left 등)

## 38.6 JS 파싱과 실행 
HTML은 한 줄씩 파싱되다가 `script`태그를 만나며 DOM파싱을 중단하고 script를 실행시킨다.  
이때 JS는 JS에서 처리한다.  

> 토크나이징 
> 단순한 문자열이 JS를 어휘 분석을 통해 문법적 의미를 갖는 코드의 최소단위인 토큰으로 분해한다. 

> 파싱
> 토큰들의 집합을구 구문분석해 AST(추상적 구문 트리)를 생성한다.
> AST는 토큰에 문법적 의미와 구조를 반영한 트리 구조의 자료구조이다.

> 바이트코드 생성과 실행
> 파싱의 결과로 AST가 생성되면 인터프리터가 실행할 수 있는 중간코드인 바이트 코드로 변환된다.  


## 38.7 리플로우와 리페인트
렌더트리를 기반으로 레이아웃은 페인트과정을 거쳐 브라우저에 다시 렌더링된다.  
이를 리플로우/리페인트 라고 한다.  
- 리플로우: 레이아웃을 다시 계산하는 것 (노드추가/삭제, 요소크기/위치 변경, 윈도우 리사이징 등)
- 리페인트: 렌더 트리를 기반으로 다시 페인트하는것을 말한다.  
